<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dragones & Camejos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <img src="../assets/dragon.png" class="rounded float-end" width="50" right="10" alt="No cargo la imagen">
</head>

<body data-bs-theme="dark">
    <div class="container">
        <div class="row">
            <div class="col">
                <h1>Dragones & Camejos</h1>
                <h5 id="tu_comida">Tu comida: </h5>
                <a href="crear_granja/" class="btn btn-primary mb-3" style="width: 70%;">Crear Granja</a>
                <a class="btn btn-secondary mb-3" href="../" style="width: 29%;">Volver</a>
            </div>
        </div>
    </div>

    <div class="container text-center">
        <div class="row row-cols-auto" id="granjas">

        </div>
    </div>

    <script>
        const URL_API = "http://10.0.2.15:5000";

        function response_received(response) {
            return response.json();
        }

        function request_error(error) {
            console.log("ERROR");
            console.log(error);
        }

        function mostrar_tiempo_resto(id, tiempo_resto) {
            const div_granja = document.getElementById(id);
            const tiempo_resto_div = div_granja.querySelector('.tiempo-resto');
            if (tiempo_resto_div) {
                tiempo_resto_div.innerText = `Tiempo restante: ${tiempo_resto} minutos`;
            } else {
                const new_div = document.createElement('div');
                new_div.className = 'tiempo-resto';
                new_div.innerText = `Tiempo restante: ${tiempo_resto} minutos`;
                div_granja.appendChild(new_div);
            }
        }

        function actualizar_tiempo_resto(cosecha) {
            const ahora = Date.now();
            cosecha.forEach(granja => {
                if (granja['cosechada'] === false) {
                    const tiempo_resto = Math.max(0, Math.ceil((granja['tiempo_cosecha'] - (ahora - granja['inicio'])) / 60000));
                    mostrar_tiempo_resto(granja['id'], tiempo_resto);
                    if (tiempo_resto <= 0) {
                        document.querySelector(`#${granja['id']} .btn-cosechar`).disabled = false;
                        mostrar_tiempo_resto(granja['id'], "Â¡Listo para cosechar!");
                    } else {
                        document.querySelector(`#${granja['id']} .btn-cosechar`).disabled = true;
                    }
                }
            });
        }

        function granja_eliminada(content) {
            console.log(content);
            let granja = content['granja'];
            actualizar_comida();
            document.getElementById(granja['id']).remove();
        }

        function eliminar_granja(id) {
            fetch(`${URL_API}/eliminar_granja/${id}`, { method: "DELETE" })
                .then(response_received)
                .then(granja_eliminada)
                .catch(request_error);
        }

        function granja_cosechada(content) {
            console.log(content);
            let granja = content['granja'];
            actualizar_comida();
            document.getElementById(granja['id']).remove();
        }

        function cosechar(id) {
            fetch(`${URL_API}/cosechar/${id}`, { method: "PUT" })
                .then(response_received)
                .then(granja_cosechada)
                .catch(request_error);
        }

        function cargar_granjas(content) {
            granjas = content['granjas'];
            let div_granjas = document.getElementById("granjas");

            granjas.forEach(granja => {
                let div_granja = document.createElement("div");
                div_granja.setAttribute("class", "col");
                div_granja.setAttribute("id", granja['id']);

                let btn_cosechar_disabled = granja['cosechada'] === false && (Date.now() - granja['inicio'] < granja['tiempo_cosecha'] * 60000);

                div_granja.innerHTML = `
                    <div class="col" id="${granja['id']}">
                        <div class="row">
                            <div class="col">
                                <img src="../assets/granja.png" class="img-thumbnail" style="height:210px">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <img src="../assets/${granja['tipo_granja']}.png" class="img" style="height: 5em;">
                            </div>
                            <div class="col">
                                <btn class="btn btn-success btn-cosechar d-block mx-1 mt-1 p-3" onclick="cosechar(${granja['id']})" ${btn_cosechar_disabled ? 'disabled' : ''}>Cosechar<br>+${granja['recompensa']}</btn>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <btn class="btn btn-danger d-block m-1" onclick="eliminar_granja(${granja['id']})">Eliminar<br>+${granja['precio']}</btn>
                            </div>
                        </div>
                    </div>
                `;
                div_granjas.appendChild(div_granja);
            });

            actualizar_tiempo_resto(granjas);
        }

        function cargar_comida(content) {
            cantidad_comida = content['comida'];
            h5_comida = document.getElementById("tu_comida");
            h5_comida.innerText = `Tu comida: ${cantidad_comida}`;
        }

        function actualizar_comida() {
            fetch(`${URL_API}/almacen`)
                .then(response_received)
                .then(cargar_comida)
                .catch(request_error);
        }

        fetch(`${URL_API}/granjas`)
            .then(response_received)
            .then(cargar_granjas)
            .catch(request_error);

        actualizar_comida();
    </script>
</body>

</html>
