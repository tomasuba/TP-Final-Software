<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dragones & Camejos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="icon" href="../assets/favicon.png" type="image/png">
        <img src="../assets/dragon.png" class="rounded float-end" width="50" right="10" alt="No cargo la imagen">
</head>

<body data-bs-theme="dark">
    <div class="container">
        <div class="row">
            <div class="col">
                <h1>Dragones & Camejos</h1>
                <h5 id="tu_comida">Tu comida: </h5>
                <a href="crear_granja/" class="btn btn-primary mb-3" style="width: 70%;">Crear Granja</a>
                <a class="btn btn-secondary mb-3" href="../" style="width: 29%;">Volver</a>
            </div>
        </div>
    </div>

    <div class="container text-center">
        <div class="row row-cols-auto" id="granjas">


        </div>
    </div>

    <script>
        const URL_API = "http://192.168.0.157:5000";

        function response_received(response) {
            return response.json();
        }

        function request_error(error) {
            console.log("ERROR");
            console.log(error);
        }

        function actualizar_contadores() {
            let btns_contadores = document.getElementsByClassName("contador");
            Array.prototype.forEach.call(btns_contadores, function(btn_contador) {
                let segundos_totales_restantes = btn_contador.getAttribute("contador_hasta") - Math.floor(Date.now()/1000);

                if (segundos_totales_restantes <= 0) {
                    btn_contador.classList.remove("contador");
                    btn_contador.innerText = `Cosechar\n+${btn_contador.getAttribute("recompensa")}`;
                    let id = btn_contador.getAttribute("id").slice(4);
                    btn_contador.setAttribute("onclick", `cosechar(${id})`);

                    return true;
                }

                let segundos_restantes = segundos_totales_restantes % 60;
                let minutos_totales_restantes = Math.floor(segundos_totales_restantes/60);
                let minutos_restantes = minutos_totales_restantes % 60;
                let horas_restantes = Math.floor(minutos_totales_restantes/60);

                if (segundos_restantes < 10) { segundos_restantes = "0" + segundos_restantes}
                if (minutos_restantes < 10) { minutos_restantes = "0" + minutos_restantes}

                str_tiempo_restante = `${horas_restantes}:${minutos_restantes}:${segundos_restantes}`;
                btn_contador.innerText = `Cosechar en\n${str_tiempo_restante}`;
            });
        }

        function granja_eliminada(content) {
            console.log(content);
            let granja = content['granja'];
            actualizar_comida();
            document.getElementById(granja['id']).remove();
        }

        function eliminar_granja(id) {
            fetch(`${URL_API}/eliminar_granja/${id}`, { method: "DELETE" })
                .then(response_received)
                .then(granja_eliminada)
                .catch(request_error);
        }

        function granja_cosechada(content) {
            console.log(content);
            let granja = content['granja'];
            actualizar_comida();
            document.getElementById(granja['id']).remove();
        }

        function cosechar(id) {
            fetch(`${URL_API}/cosechar/${id}`, { method: "PUT" })
                .then(response_received)
                .then(granja_cosechada)
                .catch(request_error);
        }

        function cargar_granjas(content) {
            granjas = content['granjas'];
            let div_granjas = document.getElementById("granjas");

            granjas.forEach(granja => {

                if (granja['cosechada']) {
                    return true;
                }

                let div_granja = document.createElement("div");
                div_granja.setAttribute("class", "col");
                div_granja.setAttribute("id", granja['id']);

                let btn_cosechar_disabled = granja['cosechada'] === false && (Date.now() - granja['inicio'] < granja['tiempo_cosecha'] * 60000);

                div_granja.innerHTML = `
                    <div class="col" id="${granja['id']}">
                        <div class="row">
                            <div class="col">
                                <img src="../assets/granja.png" class="img-thumbnail" style="height:210px">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-4">
                                <img src="../assets/${granja['tipo_granja']}.png" class="img" style="height: 5em;">
                            </div>
                            <div class="col">
                                <btn class="btn btn-success btn-cosechar d-block mx-2 mt-1 px-2 py-3 contador" style="width:7em; height:5em;" contador_hasta="${granja['fecha_cosecha']}" recompensa="${granja['recompensa']}" id="btn-${granja['id']}" onclick="">Cosechar en <br>00:00:00</btn>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <btn class="btn btn-danger d-block my-1 mx-3" onclick="eliminar_granja(${granja['id']})">Eliminar<br>+${granja['precio']}</btn>
                            </div>
                        </div>
                    </div>
                `;
                div_granjas.appendChild(div_granja);
            });
        }

        function cargar_comida(content) {
            cantidad_comida = content['comida'];
            h5_comida = document.getElementById("tu_comida");
            h5_comida.innerText = `Tu comida: ${cantidad_comida}`;
        }

        function actualizar_comida() {
            fetch(`${URL_API}/almacen`)
                .then(response_received)
                .then(cargar_comida)
                .catch(request_error);
        }

        fetch(`${URL_API}/granjas`)
            .then(response_received)
            .then(cargar_granjas)
            .catch(request_error);

        actualizar_comida();

        const actualizador = setInterval(actualizar_contadores, 1000);
    </script>
</body>

</html>
